--made by 4tux3 (pidzon)
local Inventory = {}
Inventory.Items = {}
Inventory.PlayerData = {}
Inventory.Events = {}
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Folder = Instance.new("Folder")
Folder.Name = "InventoryRemotes"
Folder.Parent = ReplicatedStorage
local Event = Instance.new("RemoteEvent")
Event.Name = "InventoryEvent"
Event.Parent = Folder
local Func = Instance.new("RemoteFunction")
Func.Name = "InventoryFunction"
Func.Parent = Folder

function Inventory:RegisterItem(id, data)
    if not id or not data then return end
    if self.Items[id] then return end
    self.Items[id] = data
end

function Inventory:AddPlayer(player)
    self.PlayerData[player] = {
        Slots = {},
        MaxSlots = 20,
        MaxWeight = 100,
        CurrentWeight = 0
    }
end

function Inventory:RemovePlayer(player)
    self.PlayerData[player] = nil
end

function Inventory:GetPlayerInventory(player)
    return self.PlayerData[player]
end

function Inventory:GetItemData(id)
    return self.Items[id]
end

function Inventory:CalculateWeight(player)
    local pdata = self:GetPlayerInventory(player)
    local total = 0
    for _, slot in pairs(pdata.Slots) do
        local item = self:GetItemData(slot.id)
        if item and item.Weight then
            total += item.Weight * slot.amount
        end
    end
    pdata.CurrentWeight = total
    return total
end

function Inventory:CanAdd(player, id, amount)
    local pdata = self:GetPlayerInventory(player)
    local item = self:GetItemData(id)
    if not pdata or not item then return false end
    local weight = item.Weight * amount
    if pdata.CurrentWeight + weight > pdata.MaxWeight then
        return false
    end
    for i = 1, pdata.MaxSlots do
        if not pdata.Slots[i] then
            return true
        end
        if pdata.Slots[i].id == id and item.Stackable then
            return true
        end
    end
    return false
end

function Inventory:AddItem(player, id, amount)
    local pdata = self:GetPlayerInventory(player)
    local item = self:GetItemData(id)
    if not pdata or not item then return false end
    if not self:CanAdd(player, id, amount) then return false end
    if item.Stackable then
        for slot, data in pairs(pdata.Slots) do
            if data.id == id then
                data.amount += amount
                self:CalculateWeight(player)
                Event:FireClient(player, "Updated", pdata.Slots)
                return true
            end
        end
    end
    for i = 1, pdata.MaxSlots do
        if not pdata.Slots[i] then
            pdata.Slots[i] = {id = id, amount = amount}
            break
        end
    end
    self:CalculateWeight(player)
    Event:FireClient(player, "Updated", pdata.Slots)
    return true
end

function Inventory:RemoveItem(player, id, amount)
    local pdata = self:GetPlayerInventory(player)
    for slot, data in pairs(pdata.Slots) do
        if data.id == id then
            if data.amount > amount then
                data.amount -= amount
            else
                pdata.Slots[slot] = nil
            end
            self:CalculateWeight(player)
            Event:FireClient(player, "Updated", pdata.Slots)
            return true
        end
    end
    return false
end

function Inventory:UseItem(player, id)
    local item = self:GetItemData(id)
    if not item or not item.Use then return false end
    item.Use(self, player, id)
    Event:FireClient(player, "Used", id)
    return true
end

function Inventory:Clear(player)
    local pdata = self:GetPlayerInventory(player)
    pdata.Slots = {}
    pdata.CurrentWeight = 0
    Event:FireClient(player, "Updated", pdata.Slots)
end

function Inventory:Bind(eventName, callback)
    if not self.Events[eventName] then
        self.Events[eventName] = {}
    end
    table.insert(self.Events[eventName], callback)
end

function Inventory:Trigger(eventName, player, ...)
    if not self.Events[eventName] then return end
    for _, f in ipairs(self.Events[eventName]) do
        f(self, player, ...)
    end
end

Players.PlayerAdded:Connect(function(plr)
    Inventory:AddPlayer(plr)
end)

Players.PlayerRemoving:Connect(function(plr)
    Inventory:RemovePlayer(plr)
end)

Func.OnServerInvoke = function(player, action, id, amount)
    if action == "Get" then
        return Inventory:GetPlayerInventory(player)
    elseif action == "Add" then
        return Inventory:AddItem(player, id, amount)
    elseif action == "Remove" then
        return Inventory:RemoveItem(player, id, amount)
    elseif action == "Use" then
        return Inventory:UseItem(player, id)
    end
end

Inventory:RegisterItem("Apple", {
    Weight = 1,
    Stackable = true,
    Use = function(system, player, id)
        player.Character.Humanoid.Health += 10
        system:RemoveItem(player, id, 1)
    end
})

Inventory:RegisterItem("Sword", {
    Weight = 5,
    Stackable = false,
    Use = function(system, player, id)
        system:Trigger("EquipWeapon", player, id)
    end
})

Inventory:RegisterItem("Gold", {
    Weight = 0,
    Stackable = true
})

Inventory:Bind("EquipWeapon", function(system, player, id)
    local char = player.Character
    if char and char:FindFirstChild("Sword") == nil then
        local tool = Instance.new("Tool")
        tool.Name = "Sword"
        tool.Parent = char
    end
end)

for i = 1, 100 do
    Inventory:RegisterItem("Material"..i, {
        Weight = math.random(1,3),
        Stackable = true
    })
end

return Inventory
